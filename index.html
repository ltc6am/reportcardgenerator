<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Report Card Generator v13</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Serif:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
    <style>
        body { 
            font-family: 'Noto Sans', 'Noto Serif TC', sans-serif; 
            background: #f0f4f8;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border-radius: 1rem;
        }

        /* Tabs */
        .sentence-tab {
            transition: all 0.2s ease;
            text-align: left;
            border: 2px solid transparent;
        }
        .sentence-tab:hover { background-color: #f1f5f9; }
        .sentence-tab.active {
            background-color: #2563eb; color: white; border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        .sentence-tab.active .sub-text { color: #bfdbfe; }
        .sentence-tab .sub-text { color: #94a3b8; transition: color 0.2s; }

        /* Option Cards */
        .option-card {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid #e2e8f0;
            display: flex; flex-direction: column; justify-content: center;
            min-height: 100px;
        }
        .option-card:hover {
            transform: translateY(-2px);
            border-color: #94a3b8;
        }
        .option-card.active {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 0 0 2px #2563eb;
        }
        .option-title-zh { color: #64748b; font-weight: 500; }
        .option-card.active .option-title-zh { color: #1e40af; }

        /* Word Chips */
        .word-chip { 
            transition: all 0.15s ease; cursor: pointer; user-select: none; font-size: 0.95rem;
        }
        .word-chip:hover { transform: translateY(-1px); background-color: #f1f5f9; border-color: #64748b; }
        .word-chip.active { 
            background-color: #2563eb; color: white; border-color: #2563eb; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .word-chip.active:hover { background-color: #1d4ed8; }
        
        .step-badge { 
            width: 28px; height: 28px; border-radius: 8px; 
            background: #dbeafe; color: #1e40af; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: 800; 
        }

        .reveal-content {
            display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease-out; opacity: 0;
        }
        .reveal-content.open { grid-template-rows: 1fr; opacity: 1; margin-bottom: 1.5rem; }
        .inner-content { overflow: hidden; }
    </style>
</head>
<body class="pb-64 text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-white/50 sticky top-0 z-50 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight">Report Card Generator <span class="text-blue-600">v13</span></h1>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleInstructions()" class="text-sm font-semibold bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span data-i18n="howToUse">How to Use?</span>
                </button>
                <button onclick="toggleLanguage()" id="langBtn" class="text-sm font-bold bg-white border border-slate-300 hover:border-blue-500 text-slate-700 px-4 py-2 rounded-lg transition-colors shadow-sm min-w-[80px]">
                    En
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">

        <!-- INSTRUCTIONS -->
        <div id="instructions" class="reveal-content glass-card border-l-4 border-l-blue-500">
            <div class="inner-content p-6">
                <h2 class="text-lg font-bold text-slate-800 mb-4" data-i18n="guideTitle">How to Use</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-slate-600">
                    <div class="flex gap-3">
                        <div class="step-badge shrink-0">1</div>
                        <div><p class="font-bold text-slate-800" data-i18n="step1Title">Student Info</p><p data-i18n="step1Desc">Enter name and gender.</p></div>
                    </div>
                    <div class="flex gap-3">
                        <div class="step-badge shrink-0">2</div>
                        <div><p class="font-bold text-slate-800" data-i18n="step2Title">Select Sentences</p><p data-i18n="step2Desc">Click Tabs, then choose a style.</p></div>
                    </div>
                    <div class="flex gap-3">
                        <div class="step-badge shrink-0">3</div>
                        <div><p class="font-bold text-slate-800" data-i18n="step3Title">Customize</p><p data-i18n="step3Desc">Refine with word chips below.</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 1 -->
        <section class="glass-card p-6 md:p-8">
            <h2 class="text-lg font-bold text-slate-700 mb-6 flex items-center gap-3">
                <span class="step-badge">1</span> <span data-i18n="sec1Title">Student Details</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-slate-400 mb-2" data-i18n="lblStudentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="e.g. Chan Tai Man" 
                        class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium text-lg placeholder-slate-300"
                        oninput="updatePreview()" onblur="autoFormatNameInput()">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-slate-400 mb-2" data-i18n="lblGender">Gender</label>
                    <div class="flex gap-4">
                        <label class="flex-1 relative group">
                            <input type="radio" name="gender" value="M" checked class="peer sr-only" onchange="updatePreview()">
                            <div class="p-4 flex items-center justify-center gap-2 border-2 border-slate-100 rounded-xl cursor-pointer hover:border-blue-200 peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition-all">
                                <span class="text-xl">ðŸ‘¦</span> <span class="font-bold" data-i18n="male">Male</span>
                            </div>
                        </label>
                        <label class="flex-1 relative group">
                            <input type="radio" name="gender" value="F" class="peer sr-only" onchange="updatePreview()">
                            <div class="p-4 flex items-center justify-center gap-2 border-2 border-slate-100 rounded-xl cursor-pointer hover:border-pink-200 peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 transition-all">
                                <span class="text-xl">ðŸ‘§</span> <span class="font-bold" data-i18n="female">Female</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <!-- STEP 2: TABBED SENTENCE BUILDER -->
        <section class="glass-card p-6 md:p-8">
            <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-3">
                <span class="step-badge">2</span> <span data-i18n="sec2Title">Build Comment Structure</span>
            </h2>
            
            <!-- TABS -->
            <div class="grid grid-cols-3 gap-2 md:gap-4 mb-6">
                <button onclick="switchTab('s1')" id="tab-s1" class="sentence-tab p-4 rounded-xl flex flex-col items-center md:items-start active">
                    <span class="font-bold text-sm md:text-xl" data-i18n="tabS1">Sentence 1</span>
                    <span class="sub-text text-xs mt-1" data-i18n="tabS1Sub">Opening (Personality)</span>
                </button>
                <button onclick="switchTab('s2')" id="tab-s2" class="sentence-tab p-4 rounded-xl flex flex-col items-center md:items-start bg-slate-50 text-slate-600">
                    <span class="font-bold text-sm md:text-xl" data-i18n="tabS2">Sentence 2</span>
                    <span class="sub-text text-xs mt-1" data-i18n="tabS2Sub">Body (Performance)</span>
                </button>
                <button onclick="switchTab('s3')" id="tab-s3" class="sentence-tab p-4 rounded-xl flex flex-col items-center md:items-start bg-slate-50 text-slate-600">
                    <span class="font-bold text-sm md:text-xl" data-i18n="tabS3">Sentence 3</span>
                    <span class="sub-text text-xs mt-1" data-i18n="tabS3Sub">Closing (Advice)</span>
                </button>
            </div>

            <!-- CONTENT AREA (Dynamic) -->
            <div class="bg-slate-50 rounded-xl p-4 md:p-6 border border-slate-200">
                
                <!-- Toggle Checkbox -->
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-200">
                    <input type="checkbox" id="segmentEnabled" checked onchange="toggleCurrentSegment()" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer">
                    <label for="segmentEnabled" class="font-bold text-slate-700 cursor-pointer select-none" data-i18n="chkInclude">Include this sentence in report card</label>
                </div>

                <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- JS will inject cards here -->
                </div>
            </div>
        </section>

        <!-- STEP 3 -->
        <section id="customizationSection" class="glass-card p-6 md:p-8 hidden">
            <h2 class="text-lg font-bold text-slate-700 mb-6 flex items-center gap-3">
                <span class="step-badge">3</span> <span data-i18n="sec3Title">Fill in the Blanks</span>
            </h2>
            <div id="wordPools" class="space-y-8">
                <!-- Dynamic Pools -->
            </div>
        </section>

    </main>

    <!-- FOOTER PREVIEW -->
    <footer class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-xl border-t border-white/50 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] p-4 md:px-8 z-40">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-6 justify-between items-start md:items-center">
            <div class="flex-1 w-full">
                <div class="flex justify-between items-end mb-2">
                     <p class="text-xs text-blue-600 font-bold uppercase tracking-wider" data-i18n="previewLbl">Live Preview</p>
                     <span id="wordCount" class="text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded">0 words</span>
                </div>
                <div id="previewText" class="text-xl font-serif text-slate-800 leading-relaxed min-h-[3.5rem] p-4 bg-white rounded-xl border border-slate-200 shadow-sm transition-colors">
                    ...
                </div>
            </div>
            <div class="shrink-0 w-full md:w-auto self-center md:self-auto">
                <button onclick="copyToClipboard()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-xl shadow-xl shadow-blue-500/20 transition-all flex items-center justify-center gap-2 active:scale-95 hover:-translate-y-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    <span data-i18n="btnCopy">Copy</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-50 flex items-center gap-3 translate-y-4 font-medium">
        <div class="bg-green-500 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div>
        <span>Copied!</span>
    </div>

    <script>
        // --- TRANSLATIONS ---
        const i18n = {
            en: {
                howToUse: "How to Use?",
                guideTitle: "How to Use",
                step1Title: "Student Info", step1Desc: "Enter name and gender.",
                step2Title: "Select Sentences", step2Desc: "Click Tabs, then choose a style.",
                step3Title: "Customize", step3Desc: "Refine with word chips below.",
                sec1Title: "Student Details",
                lblStudentName: "Student Name", lblGender: "Gender", male: "Male", female: "Female",
                sec2Title: "Build Comment Structure",
                tabS1: "Sentence 1", tabS1Sub: "Opening (Personality)",
                tabS2: "Sentence 2", tabS2Sub: "Body (Performance)",
                tabS3: "Sentence 3", tabS3Sub: "Closing (Advice)",
                chkInclude: "Include this sentence in report card",
                sec3Title: "Fill in the Blanks",
                previewLbl: "Live Preview", btnCopy: "Copy",
                disabledMsg: "This sentence is currently disabled. Check the box above to enable options."
            },
            zh: {
                howToUse: "ä½¿ç”¨èªªæ˜Ž",
                guideTitle: "ä½¿ç”¨æŒ‡å—",
                step1Title: "å­¸ç”Ÿè³‡æ–™", step1Desc: "è¼¸å…¥å§“ååŠæ€§åˆ¥ã€‚",
                step2Title: "é¸æ“‡å¥å¼", step2Desc: "é»žæ“Šæ¨™ç±¤ï¼Œç„¶å¾Œé¸æ“‡é¢¨æ ¼ã€‚",
                step3Title: "è‡ªè¨‚å…§å®¹", step3Desc: "ä½¿ç”¨ä¸‹æ–¹çš„è©žå½™é€²è¡Œå¾®èª¿ã€‚",
                sec1Title: "å­¸ç”Ÿè³‡æ–™",
                lblStudentName: "å­¸ç”Ÿå§“å", lblGender: "æ€§åˆ¥", male: "ç”·", female: "å¥³",
                sec2Title: "å»ºç«‹è©•èªžçµæ§‹",
                tabS1: "ç¬¬ä¸€å¥", tabS1Sub: "é–‹é¦– (æ€§æ ¼)",
                tabS2: "ç¬¬äºŒå¥", tabS2Sub: "ä¸»é«” (è¡¨ç¾)",
                tabS3: "ç¬¬ä¸‰å¥", tabS3Sub: "ç¸½çµ (å»ºè­°)",
                chkInclude: "åœ¨è©•èªžä¸­åŒ…å«æ­¤å¥å­",
                sec3Title: "å¡«å……è©žå½™",
                previewLbl: "å¯¦æ™‚é è¦½", btnCopy: "è¤‡è£½",
                disabledMsg: "æ­¤å¥å­å·²åœç”¨ã€‚è«‹å‹¾é¸ä¸Šæ–¹æ–¹æ ¼ä»¥å•Ÿç”¨é¸é …ã€‚"
            }
        };

        let currentLang = 'en';

        // --- DATA CONFIGURATION ---
        // Added titleZH and templateZH for full Chinese support
        
        const openings = [
            { 
                id: 'op1', title: 'High Achiever', titleZH: 'å…¨èƒ½åž‹ (å„ªç•°ç”Ÿ)', 
                template: '{Name} is a {adj1} student with {adj2} potential.', 
                templateZH: '{Name}æ˜¯ä¸€ä½{adj1}çš„å­¸ç”Ÿï¼Œæ“æœ‰{adj2}æ½›è³ªã€‚',
                pools: { adj1: ['capable (æœ‰èƒ½åŠ›çš„)','intelligent (è°ç©Žçš„)','earnest (èªçœŸçš„)','disciplined (è‡ªå¾‹çš„)'], adj2: ['excellent (å„ªç§€çš„)','promising (æœ‰å‰é€”çš„)','outstanding (å‚‘å‡ºçš„)','tremendous (æ¥µå¤§çš„)'] }
            },
            { 
                id: 'op2', title: 'Quiet & Polite', titleZH: 'æ–‡éœå‹¤å¥®åž‹', 
                template: '{Name} is a {adj1} and {adj2} student who shows great respect for teachers.', 
                templateZH: '{Name}æ˜¯ä¸€ä½{adj1}åŠ{adj2}çš„å­¸ç”Ÿï¼Œéžå¸¸å°Šæ•¬å¸«é•·ã€‚',
                pools: { adj1: ['gentle (æº«å’Œçš„)','quiet (å®‰éœçš„)','calm (å†·éœçš„)'], adj2: ['polite (æœ‰ç¦®è²Œçš„)','obedient (è½è©±çš„)','courteous (è¬™æ­çš„)'] }
            },
            { 
                id: 'op3', title: 'Social & Active', titleZH: 'ç¤¾äº¤æ´»èºåž‹', 
                template: '{Name} is a very {adj1} and {adj2} student.', 
                templateZH: '{Name}æ˜¯ä¸€ä½éžå¸¸{adj1}åŠ{adj2}çš„å­¸ç”Ÿã€‚',
                pools: { adj1: ['energetic (å……æ»¿æ´»åŠ›çš„)','outgoing (å¤–å‘çš„)','cheerful (é–‹æœ—çš„)'], adj2: ['sociable (å–„æ–¼ç¤¾äº¤çš„)','positive (æ­£é¢çš„)','optimistic (æ¨‚è§€çš„)'] }
            },
            { 
                id: 'op4', title: 'Leader / Helper', titleZH: 'æ¨‚æ–¼åŠ©äºº / é ˜è¢–åž‹', 
                template: '{Name} is a {adj1} and {adj2} student who gets along well with others.', 
                templateZH: '{Name}æ˜¯ä¸€ä½{adj1}åŠ{adj2}çš„å­¸ç”Ÿï¼Œèˆ‡äººç›¸è™•èžæ´½ã€‚',
                pools: { adj1: ['helpful (æ¨‚æ–¼åŠ©äººçš„)','friendly (å‹å–„çš„)'], adj2: ['responsible (è² è²¬ä»»çš„)','trustworthy (å€¼å¾—ä¿¡è³´çš„)'] }
            },
            { 
                id: 'op5', title: 'Distracted', titleZH: 'æœ‰èƒ½åŠ›ä½†åˆ†å¿ƒåž‹', 
                template: '{Name} is an {adj1} learner with good potential.', 
                templateZH: '{Name}æ˜¯ä¸€ä½{adj1}çš„å­¸ç¿’è€…ï¼Œå…·å‚™è‰¯å¥½æ½›è³ªã€‚',
                pools: { adj1: ['active (æ´»èºçš„)','intelligent (è°ç©Žçš„)','agile (æ€ç¶­æ•æ·çš„)'] }
            },
            { 
                id: 'op6', title: 'Smart but Passive', titleZH: 'è°æ˜Žä½†è¢«å‹•åž‹', 
                template: '{Name} is a {adj1} student but {he} lacks {noun1}.', 
                templateZH: '{Name}æ˜¯ä¸€ä½{adj1}çš„å­¸ç”Ÿï¼Œä½†{he}ç¼ºä¹{noun1}ã€‚',
                pools: { adj1: ['smart (è°æ˜Žçš„)','capable (æœ‰èƒ½åŠ›çš„)'], noun1: ['initiative (ä¸»å‹•æ€§)','drive (å¹¹å‹)','confidence (è‡ªä¿¡)'] }
            }
        ];

        const bodies = [
            { 
                id: 'bd1', title: 'Strong Work Ethic', titleZH: 'å­¸ç¿’æ…‹åº¦èªçœŸ', 
                template: '{He} has worked {adv} throughout the term and demonstrates a strong sense of {noun}.', 
                templateZH: '{He}åœ¨æ•´å€‹å­¸æœŸè¡¨ç¾{adv}ï¼Œä¸¦å±•ç¾å‡ºå¼·çƒˆçš„{noun}ã€‚',
                pools: { adv: ['steadily (ç©©å®šåœ°)','diligently (å‹¤å¥®åœ°)','consistently (ä¸€è²«åœ°)'], noun: ['responsibility (è²¬ä»»æ„Ÿ)','perseverance (æ¯…åŠ›)','integrity (æ­£ç›´)'] }
            },
            { 
                id: 'bd2', title: 'Consistent Worker', titleZH: 'è¡¨ç¾ç©©å®š', 
                template: '{He} is a {adj} worker who always completes assignments {adv}.', 
                templateZH: '{He}æ˜¯ä¸€ä½{adj}çš„å­¸ç”Ÿï¼Œç¸½æ˜¯{adv}å®Œæˆä½œæ¥­ã€‚',
                pools: { adj: ['steady (ç©©å®šçš„)','conscientious (èªçœŸçš„)'], adv: ['carefully (ä»”ç´°åœ°)','punctually (æº–æ™‚åœ°)','neatly (æ•´æ½”åœ°)'] }
            },
            { 
                id: 'bd3', title: 'Satisfactory Results', titleZH: 'æˆç¸¾æ»¿æ„', 
                template: '{He} has achieved satisfactory results in most subjects.', 
                templateZH: '{He}åœ¨å¤§å¤šæ•¸ç§‘ç›®ä¸­å‡å–å¾—æ»¿æ„çš„æˆç¸¾ã€‚',
                pools: {} 
            },
            { 
                id: 'bd4', title: 'Duties / Role', titleZH: 'ç›¡è²¬æœå‹™', 
                template: '{He} deserves credit for discharging {his} duties as {role} faithfully.', 
                templateZH: '{He}æ“”ä»»{role}ä¸€è·è¡¨ç¾ç›¡è²¬ï¼Œå€¼å¾—å˜‰è¨±ã€‚',
                pools: { role: ['Class Monitor (ç­é•·)','Prefect (é ˜è¢–ç”Ÿ)','Subject Leader (ç§‘é•·)'] }
            },
            { 
                id: 'bd5', title: 'Distracted Behavior', titleZH: 'è¡¨ç¾åˆ†å¿ƒ', 
                template: 'However, {he} sometimes {verb} in class.', 
                templateZH: 'ç„¶è€Œï¼Œ{he}æœ‰æ™‚åœ¨èª²å ‚ä¸Š{verb}ã€‚',
                pools: { verb: ['lacks concentration (æ¬ ç¼ºé›†ä¸­åŠ›)','is talkative (å¤šè¨€)','daydreams (ç™¼ç™½æ—¥å¤¢)'] }
            },
            { 
                id: 'bd6', title: 'Good Behavior', titleZH: 'è¡Œç‚ºè‰¯å¥½', 
                template: '{He} is attentive and shows good response in class.', 
                templateZH: '{He}ä¸Šèª²å°ˆå¿ƒï¼Œåæ‡‰è‰¯å¥½ã€‚',
                pools: {} 
            }
        ];

        const closings = [
            { 
                id: 'cl1', title: 'General Advice', titleZH: 'ä¸€èˆ¬å»ºè­°', 
                template: '{He} should continue to {phrase} for improvement.', 
                templateZH: '{He}æ‡‰ç¹¼çºŒ{phrase}ä»¥æ±‚é€²æ­¥ã€‚',
                pools: { phrase: ['strive for excellence (è¿½æ±‚å“è¶Š)','work hard (åŠªåŠ›å·¥ä½œ)','read more broadly (å»£æ³›é–±è®€)'] }
            },
            { 
                id: 'cl2', title: 'Attitude Check', titleZH: 'å­¸ç¿’æ…‹åº¦', 
                template: '{His} {adj} attitude is reflected in the high quality of {his} school work.', 
                templateZH: '{His}{adj}çš„æ…‹åº¦åæ˜ åœ¨{his}é«˜è³ªç´ çš„èª²æ¥­ä¸­ã€‚',
                pools: { adj: ['sincere (çœŸèª çš„)','positive (ç©æ¥µçš„)','serious (åš´è‚…çš„)'] }
            },
            { 
                id: 'cl3', title: 'Need Improvement', titleZH: 'éœ€è¦æ”¹å–„', 
                template: 'If {he} can show more {noun} in {subject}, better results are expected.', 
                templateZH: 'è‹¥{he}èƒ½åœ¨{subject}è¡¨ç¾å‡ºæ›´å¤š{noun}ï¼Œé æœŸæœƒæœ‰æ›´å¥½çš„æˆç¸¾ã€‚',
                pools: { noun: ['effort (åŠªåŠ›)','focus (å°ˆæ³¨)','determination (æ±ºå¿ƒ)'], subject: ['weak subjects (å¼±å‹¢å­¸ç§‘)','English (è‹±èªž)','Mathematics (æ•¸å­¸)'] }
            },
            { 
                id: 'cl4', title: 'Social Advice', titleZH: 'ç¤¾äº¤å»ºè­°', 
                template: 'Greater success is expected if {he} pays more {noun}.', 
                templateZH: 'å¦‚æžœ{he}èƒ½ä»˜å‡ºæ›´å¤š{noun}ï¼Œé æœŸæœƒå–å¾—æ›´å¤§çš„æˆåŠŸã€‚',
                pools: { noun: ['attention to details (å°ç´°ç¯€çš„é—œæ³¨)','patience (è€æ€§)'] }
            },
            { 
                id: 'cl5', title: 'Specific Advice', titleZH: 'å…·é«”å»ºè­°', 
                template: '{He} needs greater {noun} to achieve a higher academic standard.', 
                templateZH: '{He}éœ€è¦æ›´å¤§çš„{noun}ä»¥é”åˆ°æ›´é«˜çš„å­¸è¡“æ°´å¹³ã€‚',
                pools: { noun: ['motivation (å‹•åŠ›)','self-discipline (è‡ªå¾‹)','concentration (å°ˆæ³¨åŠ›)'] }
            },
            { 
                id: 'cl6', title: 'Encouraging', titleZH: 'é¼“å‹µèªªè©±', 
                template: 'With more {noun}, {he} will be able to perform even better.', 
                templateZH: 'è‹¥èƒ½å¢žåŠ æ›´å¤š{noun}ï¼Œ{he}çš„è¡¨ç¾å°‡èƒ½æ›´é€²ä¸€æ­¥ã€‚',
                pools: { noun: ['confidence (è‡ªä¿¡)','initiative (ä¸»å‹•æ€§)'] }
            }
        ];

        // --- STATE ---
        let state = {
            activeTab: 's1',
            s1: 'op1', s1Enabled: true,
            s2: 'bd1', s2Enabled: true,
            s3: 'cl1', s3Enabled: true,
            selections: {}
        };

        // --- INIT ---
        function init() {
            // Set defaults and render
            selectOption('s1', 'op1', false);
            selectOption('s2', 'bd3', false);
            selectOption('s3', 'cl1', false);
            switchTab('s1');
        }

        // --- I18N LOGIC ---
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            
            // Update button label
            document.getElementById('langBtn').textContent = currentLang === 'en' ? "ä¸­ / En" : "En / ä¸­";
            
            // Update UI Strings
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) {
                    el.textContent = i18n[currentLang][key];
                }
            });

            // Update Placeholder
            document.getElementById('studentName').placeholder = currentLang === 'en' ? "e.g. Chan Tai Man" : "ä¾‹å¦‚: é™³å¤§æ–‡";

            // Re-render components that contain dynamic text
            switchTab(state.activeTab); 
            renderCustomization();
            updatePreview();
        }

        // --- TAB LOGIC ---
        function switchTab(tabId) {
            state.activeTab = tabId;
            
            document.querySelectorAll('.sentence-tab').forEach(t => t.classList.remove('active', 'bg-blue-600', 'text-white'));
            document.querySelectorAll('.sentence-tab').forEach(t => { 
                if(!t.classList.contains('active')) t.classList.add('bg-slate-50', 'text-slate-600');
            });
            
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
            activeBtn.classList.remove('bg-slate-50', 'text-slate-600');

            renderOptions(tabId);
            document.getElementById('segmentEnabled').checked = state[`${tabId}Enabled`];
        }

        function toggleCurrentSegment() {
            const enabled = document.getElementById('segmentEnabled').checked;
            state[`${state.activeTab}Enabled`] = enabled;
            renderOptions(state.activeTab); 
            renderCustomization();
            updatePreview();
        }

        // --- UI RENDERING ---
        function renderOptions(segment) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            let data = [];
            if(segment === 's1') data = openings;
            if(segment === 's2') data = bodies;
            if(segment === 's3') data = closings;
            
            const isEnabled = state[`${segment}Enabled`];
            if (!isEnabled) {
                container.innerHTML = `<div class="col-span-3 text-center py-10 text-slate-400 italic">${i18n[currentLang].disabledMsg}</div>`;
                return;
            }

            data.forEach(opt => {
                const isSelected = state[segment] === opt.id;
                const card = document.createElement('div');
                card.className = `option-card bg-white rounded-xl p-5 shadow-sm ${isSelected ? 'active border-blue-600 bg-blue-50' : 'border-slate-200'}`;
                card.onclick = () => selectOption(segment, opt.id, true);
                
                // Show title based on language
                const titleText = currentLang === 'en' ? opt.title : opt.titleZH;
                // Show subtitle in other language
                const subText = currentLang === 'en' ? opt.titleZH : opt.title;
                const templateToShow = currentLang === 'en' ? opt.template : opt.templateZH;

                card.innerHTML = `
                    <div class="mb-2">
                        <h3 class="font-bold ${isSelected ? 'text-blue-700' : 'text-slate-800'} text-lg leading-tight">${titleText}</h3>
                        <p class="text-sm ${isSelected ? 'text-blue-500' : 'text-slate-400'} mt-0.5">${subText}</p>
                    </div>
                    <p class="text-xs text-slate-400 leading-relaxed border-t border-slate-100 pt-2 mt-auto">${templateToShow.replace(/\{.*?\}/g, '___')}</p>
                `;
                container.appendChild(card);
            });
        }

        function selectOption(segment, id, shouldRender = false) {
            state[segment] = id;
            
            const templateData = getData(segment, id);
            Object.keys(templateData.pools).forEach(key => {
                const poolKey = `${segment}_${key}`; 
                if (!state.selections[poolKey]) {
                    if (key === 'role') {
                        state.selections[poolKey] = getRoleOptions()[0].split(' (')[0];
                    } else {
                        state.selections[poolKey] = templateData.pools[key][0].split(' (')[0];
                    }
                }
            });

            if (shouldRender) {
                renderOptions(segment);
                renderCustomization();
                updatePreview();
            }
        }

        function getData(segment, id) {
            if (segment === 's1') return openings.find(x => x.id === id);
            if (segment === 's2') return bodies.find(x => x.id === id);
            if (segment === 's3') return closings.find(x => x.id === id);
        }

        function renderCustomization() {
            const container = document.getElementById('wordPools');
            container.innerHTML = '';
            let hasPools = false;

            ['s1', 's2', 's3'].forEach((seg, index) => {
                if (!state[`${seg}Enabled`]) return;

                const data = getData(seg, state[seg]);
                const keys = Object.keys(data.pools);
                
                if (keys.length > 0) {
                    hasPools = true;
                    const section = document.createElement('div');
                    section.className = "border-l-4 border-slate-200 pl-4 py-1";
                    
                    const sentenceTitle = currentLang === 'en' ? data.title : data.titleZH;
                    const labels = currentLang === 'en' 
                        ? [`Sentence 1: ${sentenceTitle}`, `Sentence 2: ${sentenceTitle}`, `Sentence 3: ${sentenceTitle}`]
                        : [`ç¬¬ä¸€å¥: ${sentenceTitle}`, `ç¬¬äºŒå¥: ${sentenceTitle}`, `ç¬¬ä¸‰å¥: ${sentenceTitle}`];
                    
                    const title = document.createElement('h4');
                    title.className = "text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider";
                    title.textContent = labels[index];
                    section.appendChild(title);

                    keys.forEach(key => {
                        const poolWrapper = document.createElement('div');
                        poolWrapper.className = "mb-4 last:mb-0";
                        
                        const label = document.createElement('p');
                        label.className = "text-xs font-semibold text-slate-500 mb-2";
                        
                        const keyMap = { adj: "Adjective", adv: "Adverb", noun: "Noun", verb: "Verb", phrase: "Phrase", role: "Role", subject: "Subject" };
                        const keyMapZH = { adj: "å½¢å®¹è©ž", adv: "å‰¯è©ž", noun: "åè©ž", verb: "å‹•è©ž", phrase: "çŸ­èªž", role: "è·ä½", subject: "ç§‘ç›®" };
                        
                        const cleanKey = key.replace(/[0-9]/g, '');
                        label.textContent = currentLang === 'en' 
                            ? `Choose ${keyMap[cleanKey] || key}:` 
                            : `é¸æ“‡ ${keyMapZH[cleanKey] || key}:`;
                        
                        const chips = document.createElement('div');
                        chips.className = "flex flex-wrap gap-2";

                        let pool = data.pools[key];
                        if (key === 'role') pool = getRoleOptions();

                        pool.forEach(item => {
                            // item format: "English (Chinese)"
                            const parts = item.match(/^(.*?) \((.*?)\)$/);
                            const eng = parts ? parts[1] : item;
                            const chi = parts ? parts[2] : '';
                            const poolKey = `${seg}_${key}`;
                            // We persist ENGLISH selection in state
                            const isSelected = state.selections[poolKey] === eng;

                            const btn = document.createElement('button');
                            btn.className = `word-chip px-3 py-1.5 rounded-lg border text-left ${isSelected ? 'active bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-700 border-slate-200'}`;
                            btn.onclick = () => {
                                state.selections[poolKey] = eng;
                                renderCustomization();
                                updatePreview();
                            };
                            
                            // If English mode: Show "English (Chinese)"
                            // If Chinese mode: Show "Chinese (English)" for better usability
                            if (currentLang === 'en') {
                                btn.innerHTML = `<span class="font-medium">${eng}</span>${chi ? ` <span class="text-[10px] opacity-75"> ${chi}</span>` : ''}`;
                            } else {
                                btn.innerHTML = `<span class="font-medium">${chi || eng}</span> <span class="text-[10px] opacity-75"> ${eng}</span>`;
                            }
                            
                            chips.appendChild(btn);
                        });
                        
                        poolWrapper.appendChild(label);
                        poolWrapper.appendChild(chips);
                        section.appendChild(poolWrapper);
                    });
                    container.appendChild(section);
                }
            });

            const custSection = document.getElementById('customizationSection');
            if (hasPools) custSection.classList.remove('hidden');
            else custSection.classList.add('hidden');
        }

        // --- HELPERS ---
        function getRoleOptions() {
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const roles = ['Class Monitor (ç­é•·)', 'Class Monitress (å¥³ç­é•·)', 'Prefect (é ˜è¢–ç”Ÿ)', 'IT Prefect (ITé ˜è¢–ç”Ÿ)', 'Subject Leader (ç§‘é•·)'];
            return roles.filter(r => {
                if (r.includes('Monitor')) return gender === 'M';
                if (r.includes('Monitress')) return gender === 'F';
                return true;
            });
        }

        function toTitleCase(str) {
            return str ? str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : '';
        }

        function autoFormatNameInput() {
            const el = document.getElementById('studentName');
            el.value = toTitleCase(el.value);
            updatePreview();
        }

        function toggleInstructions() {
            document.getElementById('instructions').classList.toggle('open');
        }

        // --- PREVIEW ---
        function updatePreview() {
            const name = document.getElementById('studentName').value || (currentLang === 'en' ? "[Name]" : "[å§“å]");
            const gender = document.querySelector('input[name="gender"]:checked').value;
            
            // Define Pronouns for both languages
            const p = currentLang === 'en' 
                ? (gender === 'M' ? {sub:'He', obj:'him', poss:'his'} : {sub:'She', obj:'her', poss:'her'})
                : (gender === 'M' ? {sub:'ä»–', obj:'ä»–', poss:'ä»–çš„'} : {sub:'å¥¹', obj:'å¥¹', poss:'å¥¹çš„'});

            let fullText = "";

            ['s1', 's2', 's3'].forEach(seg => {
                if (state[`${seg}Enabled`]) {
                    const data = getData(seg, state[seg]);
                    // Choose Template based on Language
                    let text = currentLang === 'en' ? data.template : data.templateZH;
                    
                    // Replace Words
                    Object.keys(data.pools).forEach(key => {
                        const engVal = state.selections[`${seg}_${key}`] || '___';
                        
                        let displayVal = engVal;
                        // If Chinese mode, find the Chinese equivalent from the pool
                        if (currentLang === 'zh') {
                            let pool = data.pools[key];
                            if (key === 'role') pool = getRoleOptions();
                            
                            // Find the item string that starts with the English value
                            // e.g. "capable (æœ‰èƒ½åŠ›çš„)"
                            const item = pool.find(i => i.startsWith(engVal + ' ')); 
                            if (item) {
                                const parts = item.match(/^(.*?) \((.*?)\)$/);
                                if (parts && parts[2]) displayVal = parts[2]; // Use Chinese part
                            }
                        }

                        text = text.replace(new RegExp(`{${key}}`, 'g'), `<span class="text-blue-600 font-semibold bg-blue-50 px-1 rounded">${displayVal}</span>`);
                    });

                    fullText += text + (currentLang === 'en' ? " " : ""); // Add space only for English
                }
            });

            // Replace Grammar / Pronouns
            // English Logic
            if (currentLang === 'en') {
                text = fullText.trim();
                text = text.replace(/{Name}/g, `<span class="font-bold text-slate-900">${toTitleCase(name)}</span>`);
                text = text.replace(/{He}/g, p.sub);
                text = text.replace(/{he}/g, p.sub.toLowerCase());
                text = text.replace(/{His}/g, p.poss.charAt(0).toUpperCase() + p.poss.slice(1));
                text = text.replace(/{his}/g, p.poss);
                text = text.replace(/{Him}/g, p.obj.charAt(0).toUpperCase() + p.obj.slice(1));
                text = text.replace(/{him}/g, p.obj);
            } 
            // Chinese Logic
            else {
                text = fullText;
                text = text.replace(/{Name}/g, `<span class="font-bold text-slate-900">${name}</span>`);
                // Chinese pronouns are simpler (no capitalization logic needed usually)
                text = text.replace(/{He}/g, p.sub);
                text = text.replace(/{he}/g, p.sub);
                text = text.replace(/{His}/g, p.poss);
                text = text.replace(/{his}/g, p.poss);
                text = text.replace(/{Him}/g, p.obj);
                text = text.replace(/{him}/g, p.obj);
            }

            const box = document.getElementById('previewText');
            box.innerHTML = text || '<span class="text-slate-400 italic">...</span>';

            // Word Count
            const cleanText = box.innerText;
            const count = currentLang === 'en' 
                ? cleanText.trim().split(/\s+/).filter(w => w).length 
                : cleanText.length; // Character count for Chinese
            
            document.getElementById('wordCount').innerText = `${count} ${currentLang === 'en' ? 'words' : 'chars'}`;
        }

        function copyToClipboard() {
            const text = document.getElementById('previewText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => toast.classList.add('opacity-0', 'translate-y-4'), 2000);
            });
        }

        window.onload = init;
    </script>
</body>
</html>
